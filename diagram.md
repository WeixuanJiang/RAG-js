# RAG Knowledge Base 项目架构图

## 整体架构流程图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                    RAG Knowledge Base 系统架构 (with AI Classification)          │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   用户界面层     │    │    服务器层     │    │   智能分类层     │    │    数据处理层    │
│  (Frontend)     │    │   (Backend)     │    │ (AI Classifier) │    │  (Processing)   │
└─────────────────┘    └─────────────────┘    └─────────────────┘    └─────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              文档上传流程                                        │
└─────────────────────────────────────────────────────────────────────────────────┘

用户上传文档
     │
     ▼
┌─────────────┐     HTTP POST      ┌─────────────┐
│ index.html  │ ──────────────────► │ server.js   │
│ script.js   │    /upload          │             │
│ style.css   │                     │ (路由处理)   │
└─────────────┘                     └─────────────┘
                                           │
                                           ▼
                                  ┌─────────────────┐
                                  │documentProcessor│
                                  │.js              │
                                  │                 │
                                  │• PDF解析        │
                                  │• 文本分块       │
                                  │• 元数据提取     │
                                  └─────────────────┘
                                           │
                                           ▼
                                  ┌─────────────────┐
                                  │ vectorStore.js  │
                                  │                 │
                                  │• 向量化         │ chunks -> embedding model -> high dimentional vectors (1536)
                                  │• FAISS索引      │ index -> HNSW -> embeeding + chunk 
                                  │• 持久化存储     │  save to local dist
                                  └─────────────────┘
documents - 100k 
- chunks 1000 tokens -> 750 words , chunkoverlap chunk1 20 tokens chunk2 20 tokens 
- chunk + metadata (name of file, date, number of token...)
- chunk -> embedding
- embedding -> vectordb

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              智能查询处理流程                                     │
└─────────────────────────────────────────────────────────────────────────────────┘

用户提问
     │
     ▼
┌─────────────┐     HTTP POST      ┌─────────────┐
│ script.js   │ ──────────────────► │ server.js   │
│             │  /query 或          │             │
│• 问题输入   │  /hybrid-query 或   │• 路由分发   │
│• 搜索类型   │  /combined-search   │• 参数验证   │
│• 结果显示   │  /web-search        └─────────────┘
└─────────────┘                            │
                                           ▼
                                  ┌─────────────────┐
                                  │questionClassifier│
                                  │.js              │
                                  │                 │
                                  │• 问题分类       │
                                  │• 意图识别       │
                                  │• 模式匹配       │
                                  └─────────────────┘
                                           │
                               ┌───────────┴───────────┐
                               ▼                       ▼
                      ┌─────────────────┐    ┌─────────────────┐
                      │   DIRECT 路径   │    │   SEARCH 路径   │
                      │                 │    │                 │
                      │• 个人问题       │    │• 文档相关问题   │
                      │• 问候语         │    │• 复杂查询       │
                      │• 通用知识       │    │• 当前事件       │
                      │• 数学计算       │    └─────────────────┘
                      └─────────────────┘              │
                               │                       ▼
                               ▼                ┌─────────────────┐
                      ┌─────────────────┐      │ queryEngine.js  │
                      │  直接回答       │      │                 │
                      │                 │      │• 查询协调       │
                      │• directQuery()  │      │• 结果整合       │
                      │• 无需搜索       │      │• LLM调用        │
                      │• AI知识库       │      └─────────────────┘
                      │• 自然对话       │              │
                      └─────────────────┘              ▼
                               │              ┌─────────────────────────┐
                               │              │    搜索引擎选择          │
                               │              └─────────────────────────┘
                               │                       │
                               │        ┌──────────────┼──────────────┐
                               │        ▼              ▼              ▼
                               │ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
                               │ │向量搜索     │ │混合搜索     │ │网络搜索       │
                               │ │             │ │             │ │(Tavily)     │
                               │ │vectorStore  │ │hybridSearch │ │tavilySearch │
                               │ │.js          │ │Engine.js    │ │.js          │
                               │ │             │ │             │ │             │
                               │ │• 语义搜索   │ │• 关键词+语义│ │• 实时搜索   │
                               │ │• 相似度计算 │ │• RRF融合    │ │• 网络结果   │
                               │ └─────────────┘ │• 权重调节   │ │• AI优化     │
                               │                 │• 分数归一化 │ └─────────────┘
                               │                 └─────────────┘
                               │                       │
                               └───────────────────────┼─────────────────────────┘
                                                       ▼
                                  ┌─────────────────┐
                                  │ queryEngine.js  │
                                  │                 │
                                  │• 结果后处理     │
                                  │• 上下文构建     │
                                  │• LLM生成答案    │
                                  └─────────────────┘
                                           │
                                           ▼
                                  ┌─────────────────┐
                                  │ server.js       │
                                  │                 │
                                  │• JSON响应       │
                                  │• 错误处理       │
                                  └─────────────────┘
                                           │
                                           ▼
┌─────────────┐     HTTP Response   ┌─────────────┐
│ script.js   │ ◄──────────────────  │ server.js   │
│             │                     │             │
│• 结果解析   │                     │• 数据返回   │
│• UI更新     │                     └─────────────┘
│• 详细信息   │
│• 统计显示   │
└─────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              数据存储结构                                        │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────┐
│ uploads/    │  ← 临时文件存储
└─────────────┘
       │
       ▼
┌─────────────────────────────────────────┐
│ vector_store/                           │
│                                         │
│ ├── docstore.json    ← 文档元数据       │
│ ├── faiss.index     ← 向量索引         │
│ └── metadata.json   ← 系统元数据       │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              核心组件详解                                        │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────┐
│ server.js       │  ← 主服务器文件 (✨ 已重构优化)
│                 │
│• Express服务器  │
│• 智能路由分发   │
│• 中间件配置     │
│• 全端点分类     │
│• 错误处理       │
│• 文件上传       │
│                 │
│🆕 工具函数:     │
│• asyncHandler() │  ← 统一错误处理
│• formatQuery    │  ← 响应格式化
│  Response()     │
│• validateQuestion│ ← 参数验证中间件
│• classifyAnd    │  ← 智能分类中间件
│  HandleDirect   │
│  Query()        │
└─────────────────┘

┌─────────────────┐
│questionClassifier│  ← 🆕 问题分类器
│.js              │
│                 │
│• 智能问题分类   │
│• LLM分类调用    │
│• 意图识别       │
│• 模式匹配       │
│• 多语言支持     │
└─────────────────┘

┌─────────────────┐
│ queryEngine.js  │  ← 🔄 增强查询协调器 (✨ 已优化)
│                 │
│• 智能分类集成   │
│• directQuery()  │
│• searchQuery()  │
│• hybridQuery()  │
│• webSearchQuery()│
│• combinedSearch │
│  Query()        │
│• 双模式PROMPT   │
│• LLM集成        │
│• 上下文构建     │
│• 多语言支持     │
│                 │
│🗑️ 已移除:       │
│• queryWith      │  ← 未使用的方法
│  CustomPrompt() │
│• summarize      │  ← 未使用的方法
│  Documents()    │
└─────────────────┘

┌─────────────────┐
│ tavilySearch.js │  ← 🆕 网络搜索引擎
│                 │
│• Tavily API集成 │
│• 实时网络搜索   │
│• AI优化结果     │
│• 智能答案生成   │
│• 元数据封装     │
└─────────────────┘

┌─────────────────┐
│documentProcessor│  ← 文档处理引擎
│.js              │
│                 │
│• PDF解析        │
│• 文本提取       │
│• 智能分块       │
│• 元数据生成     │
└─────────────────┘

┌─────────────────┐
│ vectorStore.js  │  ← 向量存储管理
│                 │
│• FAISS集成      │
│• 向量化处理     │
│• 索引管理       │
│• 持久化        │
└─────────────────┘

┌─────────────────┐
│hybridSearch     │  ← 🔄 混合搜索引擎 (✨ LangChain集成)
│Engine.js        │
│                 │
│🆕 LangChain架构:│
│• BM25Retriever  │  ← extends BaseRetriever
│• EnsembleRetriever│ ← extends BaseRetriever
│• RRF算法融合    │
│                 │
│核心功能:        │
│• 关键词搜索     │  ← TF-IDF + Natural.js
│• 语义搜索       │  ← Vector similarity
│• 混合搜索       │  ← RRF fusion
│• 权重可配置     │  ← 0.3 keyword, 0.7 semantic
│                 │
│技术栈:          │
│• @langchain/core│
│• @langchain/    │
│  community      │
│• natural (TF-IDF)│
└─────────────────┘

┌─────────────────┐
│ script.js       │  ← 前端逻辑
│                 │
│• 用户交互       │
│• AJAX请求       │
│• 结果渲染       │
│• 状态管理       │
└─────────────────┘

┌─────────────────┐
│ style.css       │  ← 样式定义
│                 │
│• 响应式设计     │
│• 组件样式       │
│• 动画效果       │
│• 主题配色       │
└─────────────────┘

┌─────────────────┐
│ index.html      │  ← 页面结构
│                 │
│• DOM结构        │
│• 表单元素       │
│• 容器布局       │
│• 脚本引用       │
└─────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              技术栈总览                                          │
└─────────────────────────────────────────────────────────────────────────────────┘

前端技术:
• HTML5 + CSS3 + JavaScript (ES6+)
• 响应式设计
• AJAX异步通信

后端技术:
• Node.js + Express.js
• Multer (文件上传)
• CORS (跨域支持)

🆕 AI/ML技术:
• OpenAI GPT (文本生成 + 问题分类)
• OpenAI Embeddings (向量化)
• FAISS (向量搜索)
• LangChain (AI工具链)
  - @langchain/core (核心功能)
  - @langchain/community (社区集成) ✨ 已升级
  - @langchain/openai (OpenAI集成)
• Tavily API (智能网络搜索)

🔄 搜索技术:
• 智能问题分类 (DIRECT vs SEARCH)
• 语义搜索 (向量相似度)
• 关键词搜索 (BM25 + TF-IDF) ✨ LangChain集成
• 混合搜索 (RRF融合) ✨ EnsembleRetriever
• 网络搜索 (实时信息)
• BaseRetriever架构 ✨ 新增

文档处理:
• PDF解析
• 文本分块
• 元数据提取
• 智能索引

🆕 响应模式:
• 直接回答模式 (AI知识库)
• 搜索回答模式 (文档+网络)
• 自适应路由选择

┌─────────────────────────────────────────────────────────────────────────────────┐
│                            智能分类决策逻辑                                       │
└─────────────────────────────────────────────────────────────────────────────────┘

DIRECT 模式触发条件:
✅ 个人问题: "What is your name?", "你叫什么名字?"
✅ 问候语: "Hello", "你好", "How are you?"
✅ 通用知识: "What is gravity?", "什么是重力?"
✅ 数学计算: "Calculate 2+2", "计算1+1"
✅ 对话交流: 不涉及特定文档或实时信息的问题

SEARCH 模式触发条件:
🔍 文档引用: "What does the document say...", "根据文档..."
🔍 文件内容: "According to the uploaded file...", "文件中提到..."
🔍 当前事件: "Latest news about...", "最新的...消息"
🔍 特定信息: 需要搜索特定文档或网络信息的问题

分类方式:
1. 模式匹配 (快速识别常见情况)
2. LLM智能分类 (处理复杂场景)
3. 默认保守策略 (不确定时选择SEARCH)

┌─────────────────────────────────────────────────────────────────────────────────┐
│                            代码重构与优化 (2026-01)                              │
└─────────────────────────────────────────────────────────────────────────────────┘

## 重构成果

### server.js 优化
✅ **消除代码重复** - 减少 220+ 行重复代码
✅ **统一错误处理** - asyncHandler() 中间件
✅ **统一响应格式** - formatQueryResponse() 工具函数
✅ **智能分类中间件** - classifyAndHandleDirectQuery()
✅ **参数验证中间件** - validateQuestion()

### queryEngine.js 清理
✅ **移除未使用方法** - 减少 91 行代码
  • queryWithCustomPrompt() - 从未调用
  • summarizeDocuments() - 从未调用

### 代码指标改进

| 文件 | 重构前 | 重构后 | 减少 | 改进率 |
|------|--------|--------|------|--------|
| server.js | 381 行 | 270 行 | -111 行 | -29% |
| queryEngine.js | 857 行 | 766 行 | -91 行 | -11% |
| **总计** | **1,238 行** | **1,036 行** | **-202 行** | **-16%** |

### 架构改进

```
重构前:
┌──────────────┐
│ 8个端点      │  每个端点都有:
│              │  • 重复的错误处理 (try-catch)
│/query        │  • 重复的验证逻辑
│/direct-query │  • 重复的分类逻辑
│/hybrid-query │  • 重复的响应格式化
│/web-search   │  • 220+ 行重复代码
│/combined-    │
│ search       │
│/status       │
│/clear        │
└──────────────┘

重构后:
┌──────────────┐     ┌──────────────────┐
│ 8个端点      │────►│ 工具函数层        │
│              │     │                  │
│/query        │     │• asyncHandler()  │
│/direct-query │     │• formatQuery     │
│/hybrid-query │     │  Response()      │
│/web-search   │     │• validateQuestion│
│/combined-    │     │• classifyAnd     │
│ search       │     │  HandleDirect    │
│/status       │     │  Query()         │
│/clear        │     └──────────────────┘
└──────────────┘
    │
    └─► 代码复用, 易于维护, 一致性保证
```

### 质量提升

1. **DRY原则** ✅
   - 消除代码重复
   - 单一真实来源

2. **可维护性** ✅
   - Bug修复自动应用到所有端点
   - 新端点易于添加

3. **可读性** ✅
   - 端点专注业务逻辑
   - 中间件处理横切关注点

4. **可测试性** ✅
   - 工具函数可独立测试
   - 端点逻辑更简单

### 依赖项验证

✅ **node-fetch** - 被 digest-fetch 使用 (传递依赖)
✅ **uuid** - 被 natural 包使用 (传递依赖)
✅ 所有依赖项都在使用中

### 最佳实践应用

1. **中间件模式** - Express.js 标准实践
2. **错误处理** - 集中式错误处理
3. **代码复用** - 工具函数提取
4. **验证** - 中间件验证